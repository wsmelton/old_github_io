<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">

        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

        <link href="https://fonts.googleapis.com/css?family=Ubuntu|Ubuntu+Mono" rel="stylesheet"> 

        <title>Search-SqlErrorLog</title>

        <link rel="stylesheet" href="/css/stylesheet.css">
    </head>
    <body>
      <div class="container-fluid">
        <nav class="navbar navbar-expand-md navbar-light">

          
          <span class="navbar-brand mb-0 h1"></span>

          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle Navigation" name="button">
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
              <a class="nav-item nav-link " href="/">Home</a>
              <a class="nav-item nav-link" href="https://github.com/wsmelton" target="_blank">GitHub</a>
              
              <a class="nav-item nav-link " href="/about/">About</a>
            </div>
          </div>
        </nav>

        <section id="page-title">
          <h1><a href="/">Shawn&#39;s Notebook</a></h1>
          <span id="author-name">
            <h6><a href="/about/">Shawn Melton</a></h6>
          </span>
        </section>


<div class="blog-post">
  <h1>Search-SqlErrorLog</h1>
  <div class="blog-post-subheader">
    <time>22 Dec 2014</time>
  </div>
  <div class="blog-post-content">
    <p>I have had a thought on how I might write this function for some time and finally decided to just sit down and do it.</p>

<p>When you have alerts setup or just in general need to troubleshoot a given instance of SQL Server one of the first steps is always looking through the ERRORLOG files for the instance. You can do this via SSMS or even via T-SQL with a known (but undocumented) stored procedure <a href="http://www.mssqltips.com/sqlservertip/1476/reading-the-sql-server-log-files-using-tsql/" target="_blank"><code>sp_readerrorlog</code></a>. Either of these methods is useful if you are just looking through one log at a time. However, I configure most of the servers I manage to keep at least 15 error logs. I have a few that are set to the max at 99. Trying to search through all of those for one phrase or word can be extremely time consuming to do manually. I guess you could do this with T-SQL, but this is one of those things that PowerShell shines at by allowing more flexibility. I can easily wrap this function into a few lines that will allow me to search for a phrase against multiple servers all at once.</p>

<p>The script is provided below and includes help information so you can use the help cmdlet to pull out the examples or information about each parameter.</p>

<pre><code class="language-powershell">function Search-SqlErrorLog
{
&lt;#
    .SYNOPSIS
        Allows you to search the error logs of a given SQL Server instance
    .DESCRIPTION
        Utilizes enumeration methods within SMO to iterate through all or some of the error logs on an instance
    .PARAMETER server
        the SQL Server instance
    .PARAMETER logNumber
        number of the specific error log you want to search, or an array of them
    .PARAMETER all
        switch to indicate just search through all error logs of the instance, this is default
    .EXAMPLE
    Search-SqlErrorLog -server MyServer -value &quot;Severity: 25&quot;
    Searches all the logs of an instance for the text &quot;Severity: 25&quot;
    .EXAMPLE
    Search-SqlErrorLog -server MyServer -lognumber 0 -value &quot;Severity: 25&quot;
    Searches through latest error log of an instance for the text &quot;Severity: 25&quot;
    .EXAMPLE
    Search-SqlErrorLog -server MyServer -lognumber 2,5 -value &quot;Severity: 25&quot;
    Searches through two specific error logs for an instance for the text &quot;Severity: 25&quot;
#&gt;

    [CmdletBinding()]
    param (
        [Parameter(Mandatory = $true,Position = 0)]
        [ValidateNotNull()]
        [Alias(&quot;instance&quot;)]
        [string]$server,

        [Parameter(Mandatory = $false,Position = 1)]
        [AllowNull()]
        [int[]]$lognumber,

        [Parameter(Mandatory = $false,Position = 2)]
        [AllowNull()]
        [switch]$all = $true,

        [Parameter(Mandatory = $true,Position = 3)]
        [ValidateNotNull()]
        [string]$value
    )

    $s = New-Object Microsoft.SqlServer.Management.Smo.Server $server

if ($all)
    {
        $collection = $s.EnumErrorLogs() | select -ExpandProperty name
        for ($i = 1; $i -lt $collection.Count; $i++)
        {
            Write-Progress -Activity &quot;Reading logs&quot; -Status &quot;Reading log number $i&quot; -PercentComplete ($i / $collection.Count * 100)
        }
        foreach ($l in $collection)
        {
            $s.ReadErrorLog($l) | where { $_.Text -match $value } | select @{Label=&quot;LogNumber&quot;;Expression={$l}}, LogDate, ProcessInfo, Text
        }
    }
    else
    {
        if ($lognumber.Count -eq 1)
        {
            $s.ReadErrorLog($lognumber) | where { $_.Text -match $value } | select LogDate, ProcessInfo, Text
        }
        elseif ($logNumber.Count -gt 0)
        {
            for ($i = 1; $i -lt $logNumber.Count; $i++)
            {
                Write-Progress -Activity &quot;Reading logs&quot; -Status &quot;Reading log number $i&quot; -PercentComplete ($i / $logNumber.Count * 100)
            }
            foreach ($l in $lognumber)
            {
                $s.ReadErrorLog($l) | where { $_.Text -match $value } | select LogDate, ProcessInfo, Text
            }
        }
    }
}
</code></pre>

  </div>
</div>

      <footer>
        <hr>
        <small>
          &copy; 2018 Shawn Melton.
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> using the <a href="https://github.com/arjunkrishnababu96/basics" target="_blank">Basics</a> theme.
        </small>
      </footer>
    </div> 

    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
  </body>
</html>

